<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程安全 | 虚心若愚 求知若渴</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/hellof/static/pictures/eagle.png">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/hellof/assets/css/0.styles.2339d483.css" as="style"><link rel="preload" href="/hellof/assets/js/app.22404478.js" as="script"><link rel="preload" href="/hellof/assets/js/2.488c7013.js" as="script"><link rel="preload" href="/hellof/assets/js/15.2758bc88.js" as="script"><link rel="prefetch" href="/hellof/assets/js/10.151448d0.js"><link rel="prefetch" href="/hellof/assets/js/11.60f7af50.js"><link rel="prefetch" href="/hellof/assets/js/12.cb6c99d0.js"><link rel="prefetch" href="/hellof/assets/js/13.75e02d05.js"><link rel="prefetch" href="/hellof/assets/js/14.56817cd5.js"><link rel="prefetch" href="/hellof/assets/js/16.646aad62.js"><link rel="prefetch" href="/hellof/assets/js/17.235d0eb2.js"><link rel="prefetch" href="/hellof/assets/js/18.6a4ea89b.js"><link rel="prefetch" href="/hellof/assets/js/19.929fc64b.js"><link rel="prefetch" href="/hellof/assets/js/20.8169d0fe.js"><link rel="prefetch" href="/hellof/assets/js/21.3c7a441d.js"><link rel="prefetch" href="/hellof/assets/js/22.670a6446.js"><link rel="prefetch" href="/hellof/assets/js/23.e5f3eb97.js"><link rel="prefetch" href="/hellof/assets/js/24.c084dba4.js"><link rel="prefetch" href="/hellof/assets/js/25.9634dc26.js"><link rel="prefetch" href="/hellof/assets/js/26.71251709.js"><link rel="prefetch" href="/hellof/assets/js/27.f380250d.js"><link rel="prefetch" href="/hellof/assets/js/28.34edf848.js"><link rel="prefetch" href="/hellof/assets/js/29.12661fea.js"><link rel="prefetch" href="/hellof/assets/js/3.f7339565.js"><link rel="prefetch" href="/hellof/assets/js/30.88d243e8.js"><link rel="prefetch" href="/hellof/assets/js/31.0e0b8053.js"><link rel="prefetch" href="/hellof/assets/js/32.b1461f5a.js"><link rel="prefetch" href="/hellof/assets/js/33.147fdbc3.js"><link rel="prefetch" href="/hellof/assets/js/34.950caae2.js"><link rel="prefetch" href="/hellof/assets/js/35.6a8125a1.js"><link rel="prefetch" href="/hellof/assets/js/36.d22f7ca9.js"><link rel="prefetch" href="/hellof/assets/js/37.91738ca1.js"><link rel="prefetch" href="/hellof/assets/js/38.84e04bd1.js"><link rel="prefetch" href="/hellof/assets/js/39.da04fefc.js"><link rel="prefetch" href="/hellof/assets/js/4.11d6af14.js"><link rel="prefetch" href="/hellof/assets/js/40.8471f14f.js"><link rel="prefetch" href="/hellof/assets/js/41.6e481f1f.js"><link rel="prefetch" href="/hellof/assets/js/42.34c364c8.js"><link rel="prefetch" href="/hellof/assets/js/43.d4f40ef1.js"><link rel="prefetch" href="/hellof/assets/js/44.46f99a49.js"><link rel="prefetch" href="/hellof/assets/js/45.55fcb768.js"><link rel="prefetch" href="/hellof/assets/js/46.497903b2.js"><link rel="prefetch" href="/hellof/assets/js/47.0d891ef2.js"><link rel="prefetch" href="/hellof/assets/js/48.0885ad9e.js"><link rel="prefetch" href="/hellof/assets/js/49.415b1ea4.js"><link rel="prefetch" href="/hellof/assets/js/5.b3c64add.js"><link rel="prefetch" href="/hellof/assets/js/50.a11ed575.js"><link rel="prefetch" href="/hellof/assets/js/51.9523ab07.js"><link rel="prefetch" href="/hellof/assets/js/52.3f122d39.js"><link rel="prefetch" href="/hellof/assets/js/53.cb20ac87.js"><link rel="prefetch" href="/hellof/assets/js/54.8f6eefdf.js"><link rel="prefetch" href="/hellof/assets/js/55.6c23ebc6.js"><link rel="prefetch" href="/hellof/assets/js/56.e6c7ee57.js"><link rel="prefetch" href="/hellof/assets/js/57.d37c28eb.js"><link rel="prefetch" href="/hellof/assets/js/58.8d9b7ddb.js"><link rel="prefetch" href="/hellof/assets/js/59.be25e66d.js"><link rel="prefetch" href="/hellof/assets/js/6.eb3c2428.js"><link rel="prefetch" href="/hellof/assets/js/60.66e0bb3a.js"><link rel="prefetch" href="/hellof/assets/js/61.597ad7ae.js"><link rel="prefetch" href="/hellof/assets/js/62.d7449c53.js"><link rel="prefetch" href="/hellof/assets/js/63.1aa39cfd.js"><link rel="prefetch" href="/hellof/assets/js/64.b4626a5e.js"><link rel="prefetch" href="/hellof/assets/js/65.4baaff71.js"><link rel="prefetch" href="/hellof/assets/js/66.9feb0224.js"><link rel="prefetch" href="/hellof/assets/js/67.47aefdd0.js"><link rel="prefetch" href="/hellof/assets/js/68.96b9a36c.js"><link rel="prefetch" href="/hellof/assets/js/69.28cc6952.js"><link rel="prefetch" href="/hellof/assets/js/7.9a417936.js"><link rel="prefetch" href="/hellof/assets/js/70.68fe6dd8.js"><link rel="prefetch" href="/hellof/assets/js/71.fd343b89.js"><link rel="prefetch" href="/hellof/assets/js/72.bd7a0413.js"><link rel="prefetch" href="/hellof/assets/js/73.b5f2bc6f.js"><link rel="prefetch" href="/hellof/assets/js/74.6791830d.js"><link rel="prefetch" href="/hellof/assets/js/8.c5650d23.js"><link rel="prefetch" href="/hellof/assets/js/9.c9f6972b.js">
    <link rel="stylesheet" href="/hellof/assets/css/0.styles.2339d483.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/hellof/" class="home-link router-link-active"><!----> <span class="site-name">虚心若愚 求知若渴</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/hellof/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/hellof/java/class.html" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="/hellof/frontEnd/css/selector.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/hellof/db/mysql/executionPlan.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/hellof/linux/fileDirMg.html" class="nav-link">
  LINUX
</a></div><div class="nav-item"><a href="/hellof/python.html" class="nav-link">
  PYTHON
</a></div><div class="nav-item"><a href="/hellof/openFrame/others.html" class="nav-link">
  开源框架
</a></div><div class="nav-item"><a href="/hellof/tools/giteeVuePress.html" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/hellof/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/hellof/java/class.html" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="/hellof/frontEnd/css/selector.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/hellof/db/mysql/executionPlan.html" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/hellof/linux/fileDirMg.html" class="nav-link">
  LINUX
</a></div><div class="nav-item"><a href="/hellof/python.html" class="nav-link">
  PYTHON
</a></div><div class="nav-item"><a href="/hellof/openFrame/others.html" class="nav-link">
  开源框架
</a></div><div class="nav-item"><a href="/hellof/tools/giteeVuePress.html" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/hellof/java/class.html" class="sidebar-link">字节码文件</a></li><li><a href="/hellof/java/load.html" class="sidebar-link">类加载机制</a></li><li><a href="/hellof/java/memory.html" class="sidebar-link">内存分配</a></li><li><a href="/hellof/java/gc.html" class="sidebar-link">垃圾回收</a></li><li><a href="/hellof/java/generic.html" class="sidebar-link">泛型机制</a></li><li><a href="/hellof/java/innerclass.html" class="sidebar-link">内部类</a></li><li><a href="/hellof/java/juc.html" aria-current="page" class="active sidebar-link">线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#线程安全" class="sidebar-link">线程安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#synchronized-volatile" class="sidebar-link">synchronized &amp; volatile</a></li></ul></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#线程间通信" class="sidebar-link">线程间通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#wait-notify" class="sidebar-link">wait &amp; notify</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#lock" class="sidebar-link">Lock</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#locksupport" class="sidebar-link">LockSupport</a></li></ul></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#concurrentmodificationexception" class="sidebar-link">ConcurrentModificationException</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#解决方案" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#countdownlatch" class="sidebar-link">CountDownLatch</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#cyclicbarrier" class="sidebar-link">CyclicBarrier</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#semaphore" class="sidebar-link">Semaphore</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#reentrantreadwritelock" class="sidebar-link">ReentrantReadWriteLock</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#blockqueue" class="sidebar-link">BlockQueue</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#线程池" class="sidebar-link">线程池</a></li><li class="sidebar-sub-header"><a href="/hellof/java/juc.html#hook" class="sidebar-link">Hook</a></li></ul></li><li><a href="/hellof/java/enum.html" class="sidebar-link">枚举</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="线程安全">线程安全</h2> <h3 id="synchronized-volatile">synchronized &amp; volatile</h3> <blockquote><p>synchronized包括monitor enter和monitor exit两个JVM指令，保证在任何时候任何线程执行到monitor enter指令前都必须从主内存中获取数据，而非缓存中，monitor exit之后，共享变量被更新后的值必须刷入主内存。</p></blockquote> <blockquote><p>每个对象都有一个monitor（对象头的Mark Word存储了对象运行时数据，比如HashCode,GC分代年龄，锁状态标志，线程持有锁等，我想这个monitor是不是就是Mark Word中的一种锁信息），一个monitor的lock锁只能被一个线程同一时间持有。如果monitor的计数器为0，该线程获得之后立即对其monitor计数器+1，重入（synchronized是可重入锁），计数器累加。释放则是对计数器-1。如果计数器不为0，其他线程只能陷入阻塞，直至monitor计数器为0再次尝试获取monitor所有权。</p></blockquote> <ul><li>volatile只能修饰类成员或实例成员，synchronized修饰方法或者代码块</li> <li>volatile修饰的变量可为null，synchronized同步语句块的monitor对象不可为null</li> <li>volatile无法保证原子性，synchronized修饰的同步代码块是无法被中途打断，能够保证原子性</li> <li>皆可保证可见性，synchronized通过JVM指令保证，volatile通过机器指令的方式迫使其他线程中的工作内存中的数据失效，不得不到主内存中再次加载</li> <li>皆可保证有序性</li> <li>volatile不会使线程陷入阻塞，而synchronized则会。</li></ul> <h2 id="线程间通信">线程间通信</h2> <h3 id="wait-notify">wait &amp; notify</h3> <ul><li>此二方法为Object中的方法，所以JDK中的每一个类都拥有这两个方法</li> <li>wait方法的三个重载方法都调用wait(long timeout)，wait()等价于wait(0)，0代表永不过时</li> <li>wait方法导致当前线程进入阻塞，直到其他线程调用Object的notify或notifyAll方法，或者是阻塞时间达到了timeout而自动唤醒</li> <li><font color="red">wait &amp; notify必须拥有对象的monitor，即此二方法必须位于同步方法或者同步代码块之中，condition.await和signal一样需要monitor（lock.lock），而LockSupport.part/unpart则不需要</font></li> <li>线程执行Object的wait方法后，会释放对该对象monitor的所有权，其他线程就有机会继续争抢该monitor的所有权</li> <li>a线程中调用某对象的wait之后，a线程立马进入阻塞，后面的代码不会再执行，b线程调用同一对象的notify，a线程并不会立马就继续执行，需要b线程执行完释放该对象的monitor并且a线程获取到该对象的monitor后才会继续执行</li> <li><font color="red">notify的线程需要在wait线程之后执行，notify先执行了而后wait的再执行的话，它就只能一直wait了没有线程去notify唤醒它，condition.await和signal一样，而LockSupport.part/unpart则不需要</font></li> <li>同步代码的monitor必须与执行wait和notify一致，即用哪个对象的monitor进行同步，就只能用那个对象调用wait和notify方法</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventQueue</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> max<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> DEFAULT_MAX_EVENT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_MAX_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> max<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">//如果是有多个线程调用offer，则需要将if换为while，否则会有虚假唤醒</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queue is full&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    eventQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;new event is submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果是有多个线程调用take，则需要将if换为while，否则会有虚假唤醒</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queue is empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    eventQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Event</span> event <span class="token operator">=</span> eventQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>eventQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;event: &quot;</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">&quot; is handled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> event<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">EventQueue</span> eventQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EventQueue<span class="token punctuation">.</span>Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Producer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p><code>虚假唤醒：</code><a href="https://tool.oschina.net/apidocs/apidoc?api=jdk-zh" target="_blank" rel="noopener noreferrer">https://tool.oschina.net/apidocs/apidoc?api=jdk-zh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAACVCAIAAACIBei2AAAa5ElEQVR42u2dvW4cR9aGi3chAdqAgFMnikQBmxDwBXgIfsBSkeFQmaBMtAKazgRlCgVHlIEVyL0AA0oWIDdSotQAAwsQ70LfdM9MT/2c+u3uma7R82DhpWZ6quu/3jp1qmrv69evCgAAAKBO9pAyAAAAUC9IGQAAAKiYaUqZu3f/d//J99dffzkQv775de/xp4sv/z65N3I8mhe9VOc3X1882laSb37be/zx3ZfLf42d1iHirzZRKFDI/37bOzjdSGX+1mga6emZ3Xg31k1ViNPdfX539I8nD/Mq5/b6xqYpqeuvLw76BwUD0VvKlFTBKNOQMm3X3/xxnPuuJv6XP8bb2N0fR0/Vm/YxPcnzv5+q15cnDxZx+Hjxd/u3SJv/V0436v18nbRFsNHuoO2mmz9moWhsTcqkZvUY742l167GkXq7qm8zuzjacN63f555G0WcLCkTrXi5BDuKeUO4f3Il/u785sv+61XynS+nMJy0Ex6hdbjF3STzP0dGBShrv9UzhJT5fPPbs8en72eRWjqvyX8e+rOxRA8tq2u8dAKBy/LXeYsyU1fSzbb1M7OlRDJtM+Qldgwp0w1+iSzrYqA7izBKg29TMRcxz27v581lF8k/v7g5PHx0cG9RI/96Lsbw7n+/PT04bXOva9v7bfmdX79+cbDMk4f+Wugt7MgPZSkjFlysp4jFZFyW3VmoDoj1avbu4uHJE38tjbb8dClzfv7yVLX1pxvb1KKTevfwyYkWhVUS7j7f3fv8dimjuwj1ny100lxMsBn+Mqqv1dP5gKo/t2oRZmZGR4LI5ER/74cfvv5820l8b1a7NTy1AzkzxeXLoszsAtEFYtMZ3j5fRcmUMqv+xEhFafstJlgHAmhFnN69n0c6rr5WmRTBt5oGeKejhaadJH3gT5QkU4SI2RWmwLDaxkHlJbCdH35//eaXA1+OrSvAcdehuX3sl+d/3Q+2r3AG9pcyi/rhvlbMweQqmFB4Zhq2aZVZNIDlKJ6hahc9hdG0uim1HMJK6Owvk/zDh73X+6ukBfJBm6lrrHoc+dt1HPxSptRgO7aUydXHLUZHYGWmN7Fpo0iGVebLd68WAaplvd1/u3j1/P/jlg83nr7CjZkPM/rBVV79dKu3bqnd6dGzIqaJYHkEFVqEV8okWGUSCi5VUQmIQ0KbrvUwv+g5V6Wwyq7DD1pnEi7E1PY7OBlGoKReImkOlihl+suvZQhi7kWSUzDBXjcxr2mzh0lGbgirxHrG7jhaZLqy25fTHqqEgaE5X51njSk3aVaZQD3bRSnjuMgkj1sea2fXHvwDiZRkT71sa61yntfa5LwJrfWQlIRiKVParfQ2KmTLLKeSBKSM8dXgUubrL2rxrmaO8uni+sfLx4tVhqRFHI+UsVuHFZ9Qr+dBq7pdo37wLlvKLOKgJ60J7fJIT6Z/4OxtldmclFladM6ENrt4rDP5SJX/rlf7HZwMmVssZbwtrss3Yxzx+qPEdYBcfM8u5/87UQk9mDYl6GMe8/3W+rypJ8pbi2xhIbpkvfTYzgusONpPYoUo4B+aCypwxk/mUZWlzKJDMWtV0zHt/x60x2bLzGAatiRlPK6+on14RY4WduYK3sfeqKfGyrrR2gNd4e38D2XHfyApE8w0lbTWUFgswY5e6N0GkzL56u3cKaOFk8TF90+efDo/V6fqWfvA2FLGfCbUKZsxWT/5ub+UaT68feYsQB8L4Ui5PJ8C/nw72gJTBq5VRmz12pL04Z9ydiljQbmo/Q5NjjvFRqTM0tx1/eafB/es1lGyYlKeHLnVCBP4xeRhkYeeicSy4t2Y5Xt398fb+yennpnzome7+PKDenowf+O1OjBiu6jzHrGiR2lFWNyYc4whpUy41Mr72HWsRClzd/Pr0/nIZHRtlrdaqFBlsqVMeE6Z7YqbQsiyElEzOpbZWX/B57t7DwTb2zK9Z3bXdqpb84zxxtsVNgJIGLFcKWNVnXmqn9/+w7+IExgA2ojNjq+u1Gz2Xh0N6CvqwZmIpEzU+kgZV3B4hpag3LTbuV/KBHw4lm6whVLGGemPHSOKXvH6Spk36pnllC11r6twVDv8r60yzQKcWkqZMReY/BrItlQljqA3vx69+u75878e29m1zs9+7XdgsoxVo0uZyEiRJWVM76WC5KwScvjB6GGcDkcwNOo7EtbpFWwwppTUO7fV29smsMgubXAJ2WOUZxgKSBlteVS1+1HaqpjvfPbJ5/ulglEt62PXgfsWmByN6avoO7PAtJxjJTgiGR1xkQ+HISoXIcwaKdD015YT9EyYK8tZtGiT10f/eXz54/y/H/b/rSfEZ5Ux8rULwWv6lkqjHYTa8VVpqycDFo2I0VBTutdtSZmLi09PZK+IFF8ZoT/KsMpcq8euJAobnFcVby1lTLffxqp0aiZn5pMyN0eXBxFr5SoyASkjt8cBF5jkH1rlnm8MEII1jVXl7bcPQ8yAi9x+g25VbVV5KJuyTHIKImFlP9UqowzDlVMcrkQwuoLVW9oqffHu4xNRIpyttn1o7WvVUSjJThxzrHbnDCGrzPwnb9taF1DVZVYZ3wRGj1WxlFkOoAFfmZURot3FoBXJh0M9Qu68reeOgC4NG5Qyns11gUX6K9noIn0V6GG19+5rLqJXi5n35Y/NLhslz4mDa+2eKUKalFm6dHgWtuwUmBuvlk6Oo+2ONhvS2gkj2MD8JqhNWmWWZX1sd39ChLVnFg2qWMqkLDCZc4w2J49nV++HWmAyisYIwenrF4L49pktZfa7mAfN48ULTMVSxvdGXZ+dym/v1377YKVL+KeWw54NqiNZZa5SVqijUsyzdukJOVXK7JtLOZZFRDCQ2O5iTx6+u/h4slT2Qh2267Z3EUAfZGfBTi/hLQKd3ShjgUkqFNuVImbXL5Myq9yYBd1+XfW32PuqEsc5t06MtcDUR0K1M1dRMAa6D+GrgMQRl6JvXJm/NiGqzh7mmiiV9fwqPKOS2VXWfD4oZWwx7vW/0zNB+3uUo4ZaPt/dPVDtfhDlToBiE7XtLjBJm0Ldzk700Jo307Nz9Wn/TWhfW1zKBObTXaVdLCU3pjXJVyZGbynT9PWNNj38ryFlVPeruJTZqFVG+GFqjvVrv32YsJRJqmkRu4LYYzcz8P2/fz55UC5lDqwKYETDMxx09ulkr7jTmJ9K037NgwCaP2T1Jg1qMSmjO98Yy1ue4Vg+xMHM//Xo3I62hhvuOlZFfezih82pFh8jO5gEL32rRDexwJR51NhgpM+ElgOVs2ykOhUY8s/yj8TawqrtLBbczKkiY5slojV/tJUV9NSYfyi3D7VshilWnwEJ9/v+MpKljBHaGFJmPX0/1tyJYlLGnvR7J/Sx4k7P1l+Pbn9qlITefetmh0ZUvTy1DRF6xHpImaZGrn13uklU66Ygxzfx0KMI40gZqYas7Yj92m8fKpcywXEk5s6Yvri2GvK0CadZInp9EOpGwaZIOyHr3j60mVwpZ5heSYfzzpAZfpm7E0WQMgk+K0ocmpcmxnad/fuLa3X5+GWsrel5GHzvPIZv9y9fNLvSYlLGWDg3PlTB2aQvqEQpY/90sGZc8N6olFkU/6r9BFdnZbEc2j7QWUTswo7N6pTV+fqsMvrnxh4KfZiX91MY/tF2XvUo7vxySnqXX8qYdXj4HUzt6SxXxxfNDqaX2jMqLGXWJ+x1+lJfi0yRMl++e9XtatZ7GaPHcU729O1g6l6kLSDmLzB1sti1ysx10g8vrO24jWOBMbt1NGvvc0fGWWASt8fPm8ybQ3Xv3oN+7bcPlUuZ4GYrn/u/u41u/dKr4E4On0Ou/i6h//GVXdoxlavDxtRC3xsV3r+nxHigWyOWvg0dEXd2fvrydDirzLraq2eWK4J99J/KwcmTiJTRLNJnoWXdb1fKdDXjgXet1257q4XDhVuMHOyZNeK2rrjKqSIx51x7ShGWMlpRdj/cFzavLd2soidqBzcKZjLAeTZ+KWPeGDCO2++5vlBy247o3dF5B0rqypfv1Xx6tG1BMSmjrxWq9UmPgpQRPPKCUsaUI+6uOl3KWMcZ+zheHhuoPBrFPHMs45yMxNnw2FaZW+F8h37ttw9DSJlh3H5LpEx4r6LnW/kco5gvalcEuugXFpUWRyDKm/JsZ1NfBdaTr5lC3SfbPbC3XRHYw82qlnr2wYVa0PIWHc0kP4BVZu0ls28NNEZT6reDKS5luoakArcqDihlBjhUe1h6udppM7bGyXT/88FB0uKu3aN5DtpK6gqb0vldvfnp5N4D3xqKJWVWR5kta5vhd7wMsGlms8RqF/AfGorkKz+9UqZtfrPZ+6uc/Snppyaqrk+32rl/tUWPrSo5V8ZSpZ1+cqSMklplWMr4t+F4jsgzfnjqWRUKnCsTWGCKGDhzpEzJZuy4lGnnstlH5OmhSe23F9VYZaQXJRyL4rZiceix+w351iEznoYk6pSQtU/b+bl+1HuKlEm/q9KRaEGP3YQMNB8wjqsukTL6KoS74pZmR08ZfyNSxkiz341obKvM2rNpNlNHb0b3jynKSjM3uk7R2cT4al8YMwy7hc9WeSXe3pK5ZVpyWbD8OcwzKO29M4tLo9RzzfsnkBnn2kRkJDVjxCHxXJnFcs+Z0T0tRNtH01NBsEhbofW6TlLoJaVFrqIj8iQvHH2b6yomqysUhK5f9pVZT7DUYr1M7xPCUmb5rWe7vrSO6fbpmSOZv4rmHkjTf4HJSmav9tuLiqVMzI4iS5k734qG3ind/HH06sSZzNgBZt+LZJ+pkSJl7MI6LThEbQgpY+5OzVhgaqaFV+r8/Oz0dL0eJ8wkY4e0DSJlXItcc/Dz7fP2jsOkMpAzN0/KGKpwOQhdbuAEtuysDB93240HZxfXPxwePNK6ws93t7+3F24dr/f++LrLEquMFkFPP+I7uyk8p+yVVxmHDSbk+UxaJJKjt2yN4uhrDerR/rq3lLEajiNlGne2R0oVSRnLODH/56vvjD32y5g8u71vn5u8fPv98A4m2Tjnv4PJ8DOwvG3WVaKflBH2iA15KeNgbr+RI/JypExRO5qSlFktsp9f/73/ynqRvAwRdxMRXalmTjjCzMf9ecL2hZin42l3q+LKPS5BynQTeOHq06RDmQeQMg+CNVmoG8ZOl33bHu9U+PgUdwApk3HJRbpAybpq3DRXOEPvhm5g7vuu9OP819vVjmV3k2ZK/XKW5/arI57XpMsa4+LAdQXIW75JzKveR4+75wcucb0rPOYl7auZ6506pJSRZjPz6P18a/Y13ilB/nWSnhuOvG6/cvaGpIy2Icvx3xLyxHUSdxMVWGBKkjLLltId3XEWNLMXsF0pIxZEWTvaqpSxz3fytzhnZInrNtE5T/DVVWa9tU2PM8H3y5tQ/1gpXgJwox5HpIy3Ed19vnfvgW0I9I0s/aVM20Gp9TpybCeRcF5l47kcOCtu/snT22dvXjwaTcpEtzon5qbb56asMkin1fnOUxrtntjcrLSzddVgE297MduSubHiSj/QVmvJ0c2cBs5h2Mqy+zWH62hHd8xcK33K8k1iXpVv1e56w9AuXHHbnRzh9x77ZzyG/WSu50KfDCnjt8rcrsq63VOdcUvuubu85cbKaHrWGQRe12/JQm4tFnitMq2Z2h/pY8mvNvFOtJzLmMRhMnyujDt505peefs18ye/HWVJGctzovTsrm6LQ/REE09uhK+UWWaS924v21BnVg2fHF+nPe9I9yba//wgX5iatoMpGe/pf7pySiwj/ZyO5ZTA8ArqGecCv/WhfGU2jn/I9OVC+BjHAWKUmpV615l1WZ1gSNSO3LVtCXqzjMzq3BZrnHnzq3phnNlzfv7y4/5y8JNsbP6rjLPzquhYoIQDyMWfeOyFohSWz9rxBt9HyvhOXxhCyhyqP94+VT/3aREeKeMZTrw7Wv0OdsJvfTuY4v6PWeberGywe/DQMcHaw8fGGqKlqGY+Z5GM9qslvOB4rRQBpLeFUW67yyJY8YwnnWpQYLha7X5o7k5WWUOvEWH5xPNcX5niLCu2R65iePhnc8RUyDpVcH7mSFKmZUJSZtBcqIDAwod/GN6BrPC3881QcPE9wOTYdjvaFKNJVdgko49cVUgZAAAAABmkDAAAAFQMUgYAAAAqBikDAAAAFYOUAQAAgIpBygAAAEDFIGUAAACgYpAyAAAAUDFIGQAAAKgYpAwAAABUDFIGAAAAKgYpAwAAABWDlAEAAICKQcoAAABAxSBlAAAAoGKQMgAAAFAxSBkAAACoGKQMAAAAVAxSBgAAACoGKQMAAAAVg5QBAACAikHKAAAAQMUgZQAAAKBikDIAAABQMUiZEdnbGzh7ewY4//n8v5Q4AADsEkiZsRhcx/QMdqT4AAAAbJedHd62a4EYSjeIqSgLHCkDAAA7yRaGt82IjMHfkhVgim5ICRApAwAAEGY7w1ulw2pitNNTt8nVokrzHAAAIAxSZvhoI2UAAAA2hnd4WyxtdMwf6z5Z/CT6gBtU9/liWPUFKAalv05/PvywLyZWUGL4vnyI56kkGsTw9XwI/ET8CikDAACgfFLGGva6fwY+V84IHfg7/LzSxErxe5U0eEcjlpjeSJ4G3+uLvy9wnzDK0iXoGAAA2FUyhk/rqwIp4As/EFRW+OnKI/GHG5Ay0fAHkTJlPwEAAJg+SQtM0WG4LikjSg3rGaQMAABAFZSMza5vxw5Imdx45ubYgFKGzdgAAAAdJUN4upTx/b1FKZMVH58TTzxbk6WMyveVQcoAAAB0eIdP/Z/R5RL9seh+ovBOqMBLra9SNkD5YhL+ype6nmpGfGk02GLLUDgcAACA3YD5/YgMIjuiJqusYBXXSQIAwG6RvadXMRaOj89EBAAAABbYVwAAAKBikDIAAABQMUgZAAAAqJgqpQx+xzAqVDAAgIqor8tmmIENQDUDAKiFwfrrwOamAUeFcFCbHH5yN3Ox+WtjFB/KXBwOAABskYzOOnqSm/Kfa7cBKTP2wOPewp2Vro1JmZ3RTAUJSalv4dvUrSd3IBsBAHae7HNltnik3tZHneLrJDfM1iMwVPRGqm/FN6gDAMAE2QUps7HxBimz4ehtRsqoCVQtAAAoRr5wUZlXDul/6Dcc+W5ZcgP0vSXwq/RwwmteynOnkjIvbxLTZT2v/PdMBR4O509ufAKZE351NB/C4fjemJJvvjuwouny1TcVrD/R+uYriKzaBQAAEyHv7uiwn0Hx3c7F1o7EpYGUG7DFdBXcvD1IPqT7c0TDGeTzwHsHzLfxwh+qogIAwASJ9Omdghl2aB9KymR9qIYe2keVMrmSYgwpk1siY0iZQcJPiQBWGQCASgkNuta6khpUyljP9PFBKXZ9+JaljC//sxb+dkbK4CsDAFAvESmj6xg1qJQpGyFyNUriY9+glBnEf3k3pAw6BgCgauK+JhuQMoNsaQmEOciCy55zzEk0vcVDbB8po8dzA74yfaTGxqRSoBzTaxQAAEyTDCljbSTR/5myfUYl70CJxDhHzaS8N5AuMZmB9FpvKcuHcHwC2eLGM5DPe713GCXmW0r+DBV+Sj6LK6fi29ExAABVUGV/zTADo0IFAwCoCLpsAAAAqBikDAAAAFQMUgYAAAAqBikDAAAAFfNNSJni02wBAABg4uz+0F58hg0AAABMn4HH9ZTzQjYZMhfrAAAA7DYZg3r6sWZIGQAAANgMvW5CnggFd+hMMyEAAACQC1IGAAAAKiY02Hd/W3fv+dZ6sm4Lcq80Clw55As5fGdQrpRB3wAAAFRHkj3DulEyvLE59xpnPbTALdwFb8QqAwAAsPNkS5noxuYUlRBQMN0DKtnKgpQBAAD4ZtmmlNEXmHRjjPthOGSkDAAAwDfLlqVMYFGpv5TpE0MAAACognF9ZQKHwYjySHyRL1bhoAI/QcoAAADsDEPuYNKf0QPJ0h/hbU1WfNxfheOjWHUCAADYLYYZvMMLQ1sn8TrJCcYcAAAAwgwmZbq/61UDSBkAAIDqYPAGAACAikHKAAAAQMUgZQAAAKBikDIAAABQMZOQMsXXOQEAAMA3zva1Qp9rKa1Ptp6WLRI+7OfbgXwIk5s/5CcATJ+KpYzKOf4uPTKqzo673piTD6NiZQhSBgB2D6SMENrEF7YmHr3qGCo/J1suiRGbbPwBAMJsufPq6SUzkpSZOLXEsxaQMhOPPwBAmJ2VMu4BxN0n3QVPKuGOp/RwXN8dlWCZt2IS/soXz5RArPi7mZAbT/G2rOjnvldH45kSTlZmqsxyT8mcnuEkRjWlHMUo+fJni/UKAKA/25Qy/TcuBbrgsMTx3WQZvlg7Gk7gj2gOhN+VYnxKj78rDqIe1uLDvswMZ3Ig3wLxTAknJR9Srk8vs/YNEo7voviscgy/N7fdjVevAAAGoXopk3sbdtbN2Lnh5EoZ/YcqeQwYZMgpW5gLxzMl/HC+9Qwn5Ssl2SQmImVy63NZ+Y4qZYZ1wwcASGFnpYz1yWSljG6Wn7KUSYnnlKWMGP9Avlk/R8r0LC8AgPHYWl/TX8eUBTIpKRNYuJmUlEmM52SlTM8FpkSQMkgZANgKIatGYGqb+HnoxRuUMpNdYPI5GajeiqHnDxPjWeYrkyVlssKJ5kN4gannkDxIOLm+MtHPw1UrHP9ofub+EABgDLYjZYbSMYs/omtM+jBmfeg+rNJ2jrgP7zk7a746u28CWS0OOb4E7nk29WTFX/xnVjwX5eUbLNMjKcazIJzoV74SCWR+NGcGD0cskdxyDNTGQHw2X68AAPqznWnTIFIGts7Y5Uh9AACAKAwVUIhv2j3UdJxpPQAApICUAQAAgIpBygAAAEDFIGUAAACgYiYkZQp2dAMAAMA3zoSkzDJCbFoBAACAZCanG5AyAAAAkM7kdANSBgAAANKZnG5AygAAAEA6k9MNSBkAAABIZ3K6ASkDAAAA6UxRN6BmAAAAIJHJiQZ0DAAAAKQzOd2AlAEAAIB0JqcbkDIAAACQzuR0A1IGAAAA0pmcbkDKAAAAQDoT0g1cJwkAAAC5TEjKAAAAAOSClAEAAICKQcoAAABAxSBlAAAAoGKQMgAAAFAxSBkAAACoGKQMAAAAVAxSBgAAACoGKQMAAAAVg5QBAACAikHKAAAAQMUgZQAAAKBikDIAAABQMUgZAAAAqBikDAAAAFQMUgYAAAAq5v8B4k4kta+fUbUAAAAASUVORK5CYII=" alt="sorry"></p> <h4 id="wait-sleep">wait &amp; sleep</h4> <ul><li>二者皆可使线程进入阻塞</li> <li>皆是可中断方法，被中断后都会收到中断异常</li> <li>wait是Object的方法，sleep是Thread的方法</li> <li>wait必须在同步方法中进行，sleep则不需要</li> <li>sleep不会释放monitor锁，wait会释放</li> <li>sleep方法休眠时间结束后会主动退出阻塞，wait若没指定timeout则需要被其他线程notify才会退出阻塞</li></ul> <h3 id="lock">Lock</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ReentrantLock默认为非公平锁，效率略高，但是可能出现一个线程把所有活干完的情况。</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventQueue</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> max<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> DEFAULT_MAX_EVENT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_MAX_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> max<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queue is full&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;new event is submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queue is empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Event</span> event <span class="token operator">=</span> eventQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;event: &quot;</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">&quot; is handled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> event<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">EventQueue</span> eventQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    eventQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Producer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    eventQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p><code>实现多个线程间定制通信，用同一个lock对象创建不同的condition对象，根据需求调用特定的condition对象的await和singal方法。</code></p> <h3 id="locksupport">LockSupport</h3> <h2 id="concurrentmodificationexception">ConcurrentModificationException</h2> <blockquote><p>集合中的成员变量modCount在集合每次修改时都会自增，创建迭代器对象会将当前的modCount赋值给迭代器对象的成员expectedModCount，然后再每次遍历
迭代器时都会判断modCount ?= expectedModCount</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Itr</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> cursor<span class="token punctuation">;</span>       <span class="token comment">// index of next element to return</span>
    <span class="token keyword">int</span> lastRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// index of last element returned; -1 if no such</span>
    <span class="token keyword">int</span> expectedModCount <span class="token operator">=</span> modCount<span class="token punctuation">;</span>

    <span class="token class-name">Itr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cursor <span class="token operator">!=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>modCount <span class="token operator">!=</span> expectedModCount<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="解决方案">解决方案</h3> <ul><li>Vector: 方法都加了synchronized</li> <li>Collections.public static &lt;T&gt; List&lt;T&gt; synchronizedList(List&lt;T&gt; list) {</li> <li>CopyOnWriteArrayList/CopyOnWriteArraySet/ConcurrentHashMap</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// copy出来修改完毕后，再赋值回去setArray(newElements);array = a;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="死锁">死锁</h2> <ul><li>交叉锁</li> <li>内存不足，线程a获取了10M，线程b获取了10M，如果他们的执行单元都需要20M，此时没有更多的内存了，都需要等待对方释放内存</li> <li>一问一答的数据交换，服务端错过了客户端的请求，而后双方皆处于等待中</li> <li>数据库锁/文件锁</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> READ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> WRITE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DeadLock</span> deadLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                deadLock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;READ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                deadLock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;WRITE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>PS E:\idea\xx&gt; jps -l
14352
17540 com.tab.playMybatis.DeadLock
21764 org.jetbrains.idea.maven.server.RemoteMavenServer36
19096 org.jetbrains.jps.cmdline.Launcher
6060 sun.tools.jps.Jps
PS E:\idea\xx&gt; jstack 17540
2021-12-18 18:43:14
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.311-b11 mixed mode):

&quot;DestroyJavaVM&quot; #13 prio=5 os_prio=0 tid=0x000001ceba7ca800 nid=0x6520 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;WRITE&quot; #12 prio=5 os_prio=0 tid=0x000001ced1cf0000 nid=0x608c waiting for monitor entry [0x00000096e45fe000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at com.tab.playMybatis.DeadLock.write(DeadLock.java:30)
        - waiting to lock &lt;0x00000000d5ece710&gt; (a java.lang.Object)
        - locked &lt;0x00000000d5ece720&gt; (a java.lang.Object)
        at com.tab.playMybatis.DeadLock.lambda$main$1(DeadLock.java:42)
        at com.tab.playMybatis.DeadLock$$Lambda$2/1747585824.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;READ&quot; #11 prio=5 os_prio=0 tid=0x000001ced1cef000 nid=0x3e80 waiting for monitor entry [0x00000096e44ff000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at com.tab.playMybatis.DeadLock.read(DeadLock.java:18)
        - waiting to lock &lt;0x00000000d5ece720&gt; (a java.lang.Object)
        - locked &lt;0x00000000d5ece710&gt; (a java.lang.Object)
        at com.tab.playMybatis.DeadLock.lambda$main$0(DeadLock.java:38)
        at com.tab.playMybatis.DeadLock$$Lambda$1/1078694789.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;Service Thread&quot; #10 daemon prio=9 os_prio=0 tid=0x000001ced19fb800 nid=0x6158 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C1 CompilerThread2&quot; #9 daemon prio=9 os_prio=2 tid=0x000001ced19f5800 nid=0x280c waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread1&quot; #8 daemon prio=9 os_prio=2 tid=0x000001ced0f70800 nid=0x560c waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread0&quot; #7 daemon prio=9 os_prio=2 tid=0x000001ced0f6f000 nid=0x63f0 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Monitor Ctrl-Break&quot; #6 daemon prio=5 os_prio=0 tid=0x000001ced0f6b000 nid=0x5c30 runnable [0x00000096e3efe000]
   java.lang.Thread.State: RUNNABLE
        at java.net.SocketInputStream.socketRead0(Native Method)
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
        at java.net.SocketInputStream.read(SocketInputStream.java:171)
        at java.net.SocketInputStream.read(SocketInputStream.java:141)
        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
        - locked &lt;0x00000000d5f1a100&gt; (a java.io.InputStreamReader)
        at java.io.InputStreamReader.read(InputStreamReader.java:184)
        at java.io.BufferedReader.fill(BufferedReader.java:161)
        at java.io.BufferedReader.readLine(BufferedReader.java:324)
        - locked &lt;0x00000000d5f1a100&gt; (a java.io.InputStreamReader)
        at java.io.BufferedReader.readLine(BufferedReader.java:389)
        at com.intellij.rt.execution.application.AppMainV2$1.run(AppMainV2.java:49)

&quot;Attach Listener&quot; #5 daemon prio=5 os_prio=2 tid=0x000001ced0eb9800 nid=0x2ed8 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=2 tid=0x000001ced0eb8800 nid=0x58fc runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Finalizer&quot; #3 daemon prio=8 os_prio=1 tid=0x000001ced0759800 nid=0x6378 in Object.wait() [0x00000096e3bff000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x00000000d5d88ee0&gt; (a java.lang.ref.ReferenceQueue$Lock)
        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
        - locked &lt;0x00000000d5d88ee0&gt; (a java.lang.ref.ReferenceQueue$Lock)
        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=2 tid=0x000001ced0e86000 nid=0x66fc in Object.wait() [0x00000096e3aff000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x00000000d5d86c00&gt; (a java.lang.ref.Reference$Lock)
        at java.lang.Object.wait(Object.java:502)
        at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
        - locked &lt;0x00000000d5d86c00&gt; (a java.lang.ref.Reference$Lock)
        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

&quot;VM Thread&quot; os_prio=2 tid=0x000001ced0e62800 nid=0xafc runnable

&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x000001ceba7e1000 nid=0x4b94 runnable

&quot;GC task thread#1 (ParallelGC)&quot; os_prio=0 tid=0x000001ceba7e2000 nid=0x59cc runnable

&quot;GC task thread#2 (ParallelGC)&quot; os_prio=0 tid=0x000001ceba7e3800 nid=0x4afc runnable

&quot;GC task thread#3 (ParallelGC)&quot; os_prio=0 tid=0x000001ceba7e5000 nid=0x6540 runnable

&quot;VM Periodic Task Thread&quot; os_prio=2 tid=0x000001ced1a53800 nid=0x65b0 waiting on condition

JNI global references: 316


Found one Java-level deadlock:
=============================
&quot;WRITE&quot;:
  waiting to lock monitor 0x000001ced0e89d08 (object 0x00000000d5ece710, a java.lang.Object),
  which is held by &quot;READ&quot;
&quot;READ&quot;:
  waiting to lock monitor 0x000001ced0e8c598 (object 0x00000000d5ece720, a java.lang.Object),
  which is held by &quot;WRITE&quot;

Java stack information for the threads listed above:
===================================================
&quot;WRITE&quot;:
        at com.tab.playMybatis.DeadLock.write(DeadLock.java:30)
        - waiting to lock &lt;0x00000000d5ece710&gt; (a java.lang.Object)
        - locked &lt;0x00000000d5ece720&gt; (a java.lang.Object)
        at com.tab.playMybatis.DeadLock.lambda$main$1(DeadLock.java:42)
        at com.tab.playMybatis.DeadLock$$Lambda$2/1747585824.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
&quot;READ&quot;:
        at com.tab.playMybatis.DeadLock.read(DeadLock.java:18)
        - waiting to lock &lt;0x00000000d5ece720&gt; (a java.lang.Object)
        - locked &lt;0x00000000d5ece710&gt; (a java.lang.Object)
        at com.tab.playMybatis.DeadLock.lambda$main$0(DeadLock.java:38)
        at com.tab.playMybatis.DeadLock$$Lambda$1/1078694789.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><h2 id="countdownlatch">CountDownLatch</h2> <blockquote><p>允许一个或多个线程等待直到在其他线程中执行的一组操作完成的同步辅助。</p></blockquote> <blockquote><p>A CountDownLatch用给定的计数初始化。await方法阻塞，直到由于countDown()方法的调用而导致当前计数达到零，之后所有等待线程被释放，并且任何后续的await 调用立即返回。 这是一个一次性的现象 - 计数无法重置。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计数器计数-1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//等待，直到CountDownLatch的计数为0时，主线程方能执行await后面的操作</span>
countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="cyclicbarrier">CyclicBarrier</h2> <blockquote><p>一个同步辅助类，它允许一组线程互相等待，直到到达某个公共屏障点 (common barrier point)。在涉及一组固定大小的线程的程序中，这些线程必须不时地互相等待，此时CyclicBarrier很有用。因为该barrier在释放等待线程后可以重用，所以称它为循环的barrier。</p></blockquote> <blockquote><p>CyclicBarrier支持一个可选的Runnable命令，在一组线程中的最后一个线程到达之后（但在释放所有线程之前），该命令只在每个屏障点运行一次。若在继续所有参与线程之前更新共享状态，此屏障操作很有用。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token comment">//公共屏障点，达到该值时方运行Runnable中的执行单元</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> 
    <span class="token comment">// TODO</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO</span>
            cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//一组线程相互等待，直到达到公共屏障点后才会继续运行后续代码</span>
            <span class="token comment">// TODO</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="semaphore">Semaphore</h2> <blockquote><p>一个计数信号量。从概念上讲，信号量维护了一个许可集。如有必要，在许可可用前会阻塞每一个 acquire()，然后再获取该许可。每个 release() 添加一个许可，从而可能释放一个正在阻塞的获取者。但是，不使用实际的许可对象，Semaphore 只对可用许可的号码进行计数，并采取相应的行动。</p></blockquote> <h2 id="reentrantreadwritelock">ReentrantReadWriteLock</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReadWriteLock</span> rwLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Lock</span> readLock <span class="token operator">=</span> rwLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Lock</span> writeLock <span class="token operator">=</span> rwLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 锁降级：写锁中可以获得读锁，读锁中不可获得写锁</span>
writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TODO:   </span>
writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="blockqueue">BlockQueue</h2> <h2 id="线程池">线程池</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span> <span class="token comment">//Executors.defaultThreadFactory()</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>方法execute(Runnable)中提交的新任务将在执行程序关闭时被拒绝 ，并且当执行程序对最大线程和工作队列容量使用有限边界并且饱和时。 在任一情况下， execute方法调用RejectedExecutionHandler.rejectedExecution(Runnable, ThreadPoolExecutor)其的方法RejectedExecutionHandler 。 提供了四个预定义的处理程序策略：</p> <ul><li>在默认ThreadPoolExecutor.AbortPolicy ，处理程序会引发运行RejectedExecutionException后排斥反应。</li> <li>在ThreadPoolExecutor.CallerRunsPolicy中，调用execute本身的线程运行任务。 这提供了一个简单的反馈控制机制，将降低新任务提交的速度。</li> <li>在ThreadPoolExecutor.DiscardPolicy中 ，简单地删除无法执行的任务。</li> <li>在ThreadPoolExecutor.DiscardOldestPolicy中 ，如果执行程序没有关闭，则工作队列头部的任务被删除，然后重试执行（可能会再次失败，导致重复）。</li></ul> <p>可以定义和使用其他类型的RejectedExecutionHandler类。 这样做需要特别注意，特别是当策略被设计为仅在特定容量或排队策略下工作时。
<img src="/hellof/assets/img/002.b57d628a.png" alt="sorry"></p> <h2 id="hook">Hook</h2> <blockquote><p>线程在执行单元中不允许抛出checked exception，线程运行在自己的上下文中，其派生线程无法直接获取它运行中出现的异常信息。so，java提供UncaughtExceptionHandler接口</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
        * Method invoked when the given thread terminates due to the
        * given uncaught exception.
        * &lt;p&gt;Any exception thrown by this method will be ignored by the
        * Java Virtual Machine.
        * @param t the thread
        * @param e the exception
        */</span>
    <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>当出现异常时会回调Thread的dispatchUncaughtException方法,</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
    * Dispatch an uncaught exception to the handler. This method is
    * intended to be called only by the JVM.
    */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchUncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
    * Returns the handler invoked when this thread abruptly terminates
    * due to an uncaught exception. If this thread has not had an
    * uncaught exception handler explicitly set then this thread's
    * &lt;tt&gt;ThreadGroup&lt;/tt&gt; object is returned, unless this thread
    * has terminated, in which case &lt;tt&gt;null&lt;/tt&gt; is returned.
    * @since 1.5
    * @return the uncaught exception handler for this thread
    */</span>
<span class="token keyword">public</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token function">getUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> uncaughtExceptionHandler <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
        uncaughtExceptionHandler <span class="token operator">:</span> group<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>so, 设置一个uncaughtExceptionHandler或者全局的defaultUncaughtExceptionHandler</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
    * Set the handler invoked when this thread abruptly terminates
    * due to an uncaught exception.
    * &lt;p&gt;A thread can take full control of how it responds to uncaught
    * exceptions by having its uncaught exception handler explicitly set.
    * If no such handler is set then the thread's &lt;tt&gt;ThreadGroup&lt;/tt&gt;
    * object acts as its handler.
    * @param eh the object to use as this thread's uncaught exception
    * handler. If &lt;tt&gt;null&lt;/tt&gt; then this thread has no explicit handler.
    * @throws  SecurityException  if the current thread is not allowed to
    *          modify this thread.
    * @see #setDefaultUncaughtExceptionHandler
    * @see ThreadGroup#uncaughtException
    * @since 1.5
    */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">UncaughtExceptionHandler</span> eh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uncaughtExceptionHandler <span class="token operator">=</span> eh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">UncaughtExceptionHandler</span> eh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sm<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;setDefaultUncaughtExceptionHandler&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

        defaultUncaughtExceptionHandler <span class="token operator">=</span> eh<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>ThreadGroup</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处会获取全局的defaultUncaughtExceptionHandler</span>
        <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> ueh <span class="token operator">=</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">getDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ueh <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ueh<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ThreadDeath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in thread \&quot;&quot;</span>
                                <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>诸如Runtime提供的注册Hook的方法</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
    * Registers a new virtual-machine shutdown hook.
    */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sm<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;shutdownHooks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ApplicationShutdownHooks</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/hellof/java/innerclass.html" class="prev">
        内部类
      </a></span> <span class="next"><a href="/hellof/java/enum.html">
        枚举
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/hellof/assets/js/app.22404478.js" defer></script><script src="/hellof/assets/js/2.488c7013.js" defer></script><script src="/hellof/assets/js/15.2758bc88.js" defer></script>
  </body>
</html>
